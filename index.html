<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Área Principal Temporária</title>
    <link rel="stylesheet" href="./css/user.css">
    <link rel="stylesheet" href="./css/quiz.css">

    <!-- Bootstrap -->
	<link href="bootstrap-5.0.1/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
		
	<!-- jQuery -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
	<script src="bootstrap-5.0.1/js/bootstrap.min.js"></script>
		
	<!--[if lt IE 9]>
		<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
		<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
	<![endif]-->
</head>
<body>

    <div id="quiz-area" class="container">

        <div id="quiz-game">
            <div class="quiz-area">
                <div id="hud">
                    <div class="hud-item">
                        <p id="progressText" class="hud-prefix">Questão</p>
                    </div>
                </div>
                <h1 id="question">Qual é a resposta correta?</h1>
                <div class="choice-container">
                    <p class="choice-prefix">A)</p>
                    <p class="choice-text" data-option="A">Resposta 1</p>
                </div>
                <div class="choice-container">
                    <p class="choice-prefix">B)</p>
                    <p class="choice-text" data-option="B">Resposta 2</p>
                </div>
                <div class="choice-container">
                    <p class="choice-prefix">C)</p>
                    <p class="choice-text" data-option="C">Resposta 3</p>
                </div>
                <div class="choice-container">
                    <p class="choice-prefix">D)</p>
                    <p class="choice-text" data-option="D">Resposta 4</p>
                </div>
                <div class="choice-container">
                    <p class="choice-prefix">E)</p>
                    <p class="choice-text" data-option="E">Resposta 5</p>
                </div>
            </div>
        </div>
        
    </div>

    <script type="module">

        window.sessionStorage.setItem("quizCode","2018/questao");
        const quizCode = window.sessionStorage.getItem("quizCode");

        // Faz um Array de opçoes 
        const question = document.querySelector("#question");
        const choices = Array.from(document.querySelectorAll(".choice-text"));
        const progressText = document.querySelector("#progressText");

        // Array onde as questões serão armazenadas 
        const questions = [];
        let acceptingAnswers = true;
        let currentQuestion = {}
        let questionCounter = 0;
        let avaliableQuestions = [];
        var score;

        const Http = new XMLHttpRequest();
        const url= "https://form-f5d6e-default-rtdb.firebaseio.com/provas/" + quizCode +".json";
        Http.open("GET", url);
        Http.send();

        Http.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200){
                let archieve = JSON.parse(Http.responseText);
                Object.keys(archieve).forEach(function(key) {
                    let values = archieve[key];
                    questions.push({
                        enunciado: values.enunciado,
                        optionA: values.alternativas["A"], 
                        optionB: values.alternativas["B"],
                        optionC: values.alternativas["C"],
                        optionD: values.alternativas["D"],
                        optionE: values.alternativas["E"],
                        resposta: values.resposta
                    });
                });
                return console.log(questions);
            }
        }

        // Pontuações 
        const SCORE_POINTS = 100;
        const MAX_QUESTIONS = 6;

        // Iniciar Quiz 
        var startGame = () => {
            questionCounter = 0;
            score = 0;
            avaliableQuestions = [...questions];
            getNewQuestion();
        }

        // Atualiza questões 
        var getNewQuestion = () => {
            if (avaliableQuestions.length === 0 || questionCounter > MAX_QUESTIONS){
                console.log("A sua pontuação foi de " + score + " pontos");
                return;
            }

            questionCounter++;
            progressText.innerHTML = "Questão " + questionCounter + " de " + MAX_QUESTIONS;

            const questionsIndex = Math.floor(Math.random() * avaliableQuestions.length);
            currentQuestion = avaliableQuestions[questionsIndex];
            question.innerHTML = currentQuestion.enunciado;

            choices.forEach(choice => {
                const option = choice.dataset["option"];
                choice.innerText = currentQuestion["option" + option];
            });

            avaliableQuestions.splice(questionsIndex, 1);

            acceptingAnswers = true;
        }

        // Adiciona um evento nas opções 
        choices.forEach(choice => {
            choice.addEventListener("click", e=> {
                if (!acceptingAnswers) return;

                acceptingAnswers = false;
                const selectedChoice = e.target;
                const selectedAnswer = selectedChoice.dataset["option"];

                let classToApply = selectedAnswer == currentQuestion.resposta ? "correct" : "incorrect";

                if (classToApply === "correct"){
                    incrementScore(SCORE_POINTS);
                }

                // Muda a cor das alternativas 
                selectedChoice.parentElement.classList.add(classToApply);

                setTimeout(() => {
                    selectedChoice.parentElement.classList.remove(classToApply);
                    getNewQuestion();
                },1000);
            });
        })

        // Aumenta a pontuação 
        var incrementScore = num => {
            score += num;
        }

        // Inicia o jogo 
        setTimeout(() => {
            startGame();
        },1000);

    </script>
</body>